{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/reading-a-ruby-gem-with-vscode/","result":{"data":{"site":{"siteMetadata":{"title":"wasabigeek"}},"markdownRemark":{"id":"01f31e67-65a8-5dc9-a305-055cbbcfa29a","excerpt":"Whether out of curiosity or trying to understand a method for debugging, it‚Äôs helpful to know how to dig into a Ruby gem. Recently I was curious over how mocha‚Ä¶","html":"<p>Whether out of curiosity or trying to understand a method for debugging, it‚Äôs helpful to know how to dig into a Ruby gem. Recently I was curious over how <a href=\"https://github.com/freerange/mocha/\">mocha</a>, a mocking library for minitest, allowed stubbing on <code class=\"language-text\">any_instance</code> of a Class (as opposed to injecting a stubbed object), for example:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">test_stubbing_an_instance_method_on_all_instances_of_a_class</span></span>\n  <span class=\"token constant\">Product</span><span class=\"token punctuation\">.</span>any_instance<span class=\"token punctuation\">.</span>stubs<span class=\"token punctuation\">(</span><span class=\"token symbol\">:name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>returns<span class=\"token punctuation\">(</span><span class=\"token string\">'stubbed_name'</span><span class=\"token punctuation\">)</span>\n  product <span class=\"token operator\">=</span> <span class=\"token constant\">Product</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span>\n  assert_equal <span class=\"token string\">'stubbed_name'</span><span class=\"token punctuation\">,</span> product<span class=\"token punctuation\">.</span>name\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Following this are steps you can try when investigating a gem. I‚Äôd love to say these were the exact steps I took while investigating <code class=\"language-text\">any_instance</code>, but truth is some steps I discovered only while writing this post üòÖ. The steps are specific to using VSCode.</p>\n<h2>Open the Source Code</h2>\n<p>Assuming the gem is installed, <code class=\"language-text\">gem open &lt;gemname&gt;</code> (or <code class=\"language-text\">bundle open &lt;gemname&gt;</code> if installed in a project via Bundler) will open it‚Äôs source code with the command set in the <code class=\"language-text\">$EDITOR</code> environment variable.</p>\n<p>For example <code class=\"language-text\">EDITOR=code bundle open mocha</code> from my project opens the gem in VSCode:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c55ef4a8be41a2d8f8603a57ddde1b4d/69d6b/Mocha%20opened%20in%20VSCode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABPklEQVQY013QyW7bMBSFYb1HY8mOBpuSRY0UJ0mx4QRBijZoF3n/R/nDyEEXXXw4BHk53WhcFOMw0fcD3abf0hiN1hPzPIexxTnPNGnargv6/3Tb/lEpol42GDUiipzyWHAWJ7I83wpl21EUBZUQlKfTpgrrsir/qYNzWdJKuYkqc0Xd3klqc9c44vRIlmVof8Vbx8XqwLAYw9U7nrzntizc1pVnb/m1Gv5cLKatiXL/xvnlg3T+Tba8k61/eShqsmTHq5t49Zq3WfMSxj8Xyy0c4O2MMguTXbE2pAoXTT31MSdqwpOvi8cMYUIcEVnKIYl5fEwxX8XaY92KnmzotUINI3pUnHuD6B2VWhHDTFoI4t0DkZQt69MF2bThm0XoX8Fhf2Cf5qStI20syUnyI94Hybc9u5B38d0uJg75CTdVu8erv2ggAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mocha opened in VSCode.png\"\n        title=\"Mocha opened in VSCode.png\"\n        src=\"/static/c55ef4a8be41a2d8f8603a57ddde1b4d/fcda8/Mocha%20opened%20in%20VSCode.png\"\n        srcset=\"/static/c55ef4a8be41a2d8f8603a57ddde1b4d/12f09/Mocha%20opened%20in%20VSCode.png 148w,\n/static/c55ef4a8be41a2d8f8603a57ddde1b4d/e4a3f/Mocha%20opened%20in%20VSCode.png 295w,\n/static/c55ef4a8be41a2d8f8603a57ddde1b4d/fcda8/Mocha%20opened%20in%20VSCode.png 590w,\n/static/c55ef4a8be41a2d8f8603a57ddde1b4d/efc66/Mocha%20opened%20in%20VSCode.png 885w,\n/static/c55ef4a8be41a2d8f8603a57ddde1b4d/c83ae/Mocha%20opened%20in%20VSCode.png 1180w,\n/static/c55ef4a8be41a2d8f8603a57ddde1b4d/69d6b/Mocha%20opened%20in%20VSCode.png 1912w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If the gem isn‚Äôt installed, you could also look up the source code online (<a href=\"https://rubygems.org/\">rubygems.org</a>) and if the code is on GitHub, there‚Äôs a handy <a href=\"https://twitter.com/github/status/1425505817827151872?s=21\">shortcut</a> to open it in a browser version of VSCode.</p>\n<h2>Find your Target</h2>\n<p>Now that we have our gem‚Äôs source code, we can easily search for the method declaration across all files. This is a good time to make use of search filters:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/486ed4d7639cc618d193928c541391cc/dcb79/Searching%20Mocha%20in%20VSCode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.97297297297297%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADFElEQVQ4y22Uy28bZRTF539ADU1sz/vteXrGM37bOG6aJsTQllAF6AqhCtoFCg8FdYG6hG3/4B/3G8uIBYuj787I37nnzL3H2mQyIctyirIkiiKiMCLPc+q6ISsrqqpmNp1SZBmJ68mZy7uKOI5x5dnzfHw/6KBqbbvddpcunlywWK1IRyMi+XFUVPSDlJPHn/Lo7Az9tE9WZNTjCs/3sCxLSHwcxxEijzAMpXbRptJ9VI5YrDc8bSe8KEp+ev2aj+/f89f9PR/evePPN2/4++EPbm72GI6HYZj0ej36/f4BUh+ftbquKRXhcsVqNmMiNr+7fcWH+9/59e3PvP3mjh/v7vjt+x+43G1xPZtUlPqBUmliOxaWbQssTNNAU98wGSbUQjqqRpR1S5A1GGK3pxs8ls6fnJxwNjDx05w4L4nTlDiJxaZPGPl4UUwQBvJNrYPlWF7Mxi1PVlP260ZU5gzjIV4QCtGg+16hP0S3PAamI7aDru71+h2U5b46+wO0tm1JhH3ZNiwWCy7XMy5WNetpxdN5w9dXV+SiyHQMHN/Cdk2xZxxOBUed1uEUaPP5HHc0Z7zbs3u25/nnV/xyec2L8z3fPr/l48MDny3mWKFBkMiaxE5HrC53DbxDk2OtKVVWe8Fmf8err16yu37Jl9svOL++JZ1ueXR6im7ohJmHG9kYtokuMCyjIzgqOxJ3hKlYfjarudlMWE5bRs2Y80nJvBxiWza2TNCNHNlNn7ZwWVWeLLZM1juoUuqcwO6aaDOxnMQJq+mc2WrDShosJw27qaxSlXUDUStheWIrNAkiSxIk003cfxXqut5hIAPUmqbp4palmUSuYDFK2dQJZVHI5WGXApWGXHZvuVvTLNpOrR0KYSCnDESX9VLLrqCNJGpBcIiNyqajIGlQtS0L67pyUVQOhzmT3TXlek2UDqnTiDL2SeNAtsQn8FxiWXZNBV0RHoP+XyhlyrIaShqr5S9I5E+izGI2VcQ4CST3cldsK7uG2P5fwmNt24fgK9IqK5gWMYUkQ5dGZ6J8IK5MwfH7KfwDrMLNerBWq1kAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Searching Mocha in VSCode.png\"\n        title=\"Searching Mocha in VSCode.png\"\n        src=\"/static/486ed4d7639cc618d193928c541391cc/fcda8/Searching%20Mocha%20in%20VSCode.png\"\n        srcset=\"/static/486ed4d7639cc618d193928c541391cc/12f09/Searching%20Mocha%20in%20VSCode.png 148w,\n/static/486ed4d7639cc618d193928c541391cc/e4a3f/Searching%20Mocha%20in%20VSCode.png 295w,\n/static/486ed4d7639cc618d193928c541391cc/fcda8/Searching%20Mocha%20in%20VSCode.png 590w,\n/static/486ed4d7639cc618d193928c541391cc/efc66/Searching%20Mocha%20in%20VSCode.png 885w,\n/static/486ed4d7639cc618d193928c541391cc/c83ae/Searching%20Mocha%20in%20VSCode.png 1180w,\n/static/486ed4d7639cc618d193928c541391cc/dcb79/Searching%20Mocha%20in%20VSCode.png 1700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Some ideas to try if the results list is really long:</p>\n<ul>\n<li>prefixing the search term with the declaration syntax (e.g. <code class=\"language-text\">class &lt;ClassName&gt;</code> for a class, <code class=\"language-text\">def &lt;method_name&gt;</code> for an instance method) generally works well, but not always, given the many ways to metaprogram in Ruby. For example, it‚Äôs not obvious that <code class=\"language-text\">any_instance</code> would have been defined as an instance method.</li>\n<li>‚Äù<strong>Match Whole Word</strong>‚Äù (ab) helps exclude classes / methods with the search term as a substring (e.g. it would have excluded <code class=\"language-text\">any_instance_method</code> and <code class=\"language-text\">mock_impersonating_any_instance_of</code> in the results above)</li>\n<li>‚Äù<strong>files to include</strong>‚Äù knowing the structure of most gems (see later section), we can usually restrict to the <code class=\"language-text\">lib/</code> directory, which will exclude test files, bin scripts etc</li>\n</ul>\n<h2>Trace the Callers</h2>\n<p>While we found the method, it didn‚Äôt answer our initial question, which was how <code class=\"language-text\">any_instance</code> becomes callable on any class. We could probably try a ‚Äútop-down‚Äù or ‚Äúbottom-up‚Äù search here.</p>\n<p>For <strong>‚Äúbottom-up‚Äù search</strong>, since this is plain Ruby as opposed to Rails, we could try to follow the <code class=\"language-text\">require</code> trail. But if we have an extension like <a href=\"https://marketplace.visualstudio.com/items?itemName=castwide.solargraph\">solargraph</a>, a simpler way is to make use of VSCode‚Äôs <strong>Go to References</strong>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/034c60797b097c8776c230f2742c0a7b/bb543/VSCode%20Go%20To%20References%20in%20Mocha.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACGklEQVQoz42SW0/bQBBGHUhApNAS1CJVEF/W61sITmwnthOwE0II1wYqIfWl//9vnK5Nito3Hj7N7M7u0dw0XdeRtmQQhvhJH+ELTKuLKQxs10JIE8s2a9/2hDpvrGNhbWKVhGMiXYlmGCaGYdALPPqDkLMspZ+n6pGt7nVM06hV+bp+yunpCV1lq3N9Z3Q3sS5CCDQnuWJYPDKav3BerJUeCYsHvPE1djxHDGc4yrrjJYPymfHylcH8J1ayQh9cYUXXtczhgl6+QtsWKe2gZD/5Qac/wxgU6MOSb/1LOr0LDoMpDXNcxyZ3ryxefvPw8oub+2eS8g43u8HPb/CUTcpbNM1I2LUzvngFewqy46VsmbFSQkskNK0ETU/YN8+JoyFlWfK0uOR5MWE+TfF8H8dxcJWiKHoDNq0RB/2Mz/GUvXDC7llO+zzjk1L7LGVbjhVQ9bfXY5SMmKUx13nEKOwjpYujJKVDEPTQGuaIHaFKCi7xJjn364jVU8xRENHQY1qbbA9FqD5KLGGrLVADUxJqOxzHrVUBfT9A26qA9pgDb8qJan63KPmeFbT9CQ0jrlVVcWCFdVnVZ3ejv6B/rdZUQ9mVGS1V9tfBLcfTNcf5A0fJkk44U/2L33q4Acq6PPc9s/+hag9bdsqOTNUAVJ/ci9rfEhlNOaElc6otqDL8GNB5A9YZKuChX2BN7xDlmk68eodq5seBfwDTr0IE/XzIeAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"VSCode Go To References in Mocha.png\"\n        title=\"VSCode Go To References in Mocha.png\"\n        src=\"/static/034c60797b097c8776c230f2742c0a7b/fcda8/VSCode%20Go%20To%20References%20in%20Mocha.png\"\n        srcset=\"/static/034c60797b097c8776c230f2742c0a7b/12f09/VSCode%20Go%20To%20References%20in%20Mocha.png 148w,\n/static/034c60797b097c8776c230f2742c0a7b/e4a3f/VSCode%20Go%20To%20References%20in%20Mocha.png 295w,\n/static/034c60797b097c8776c230f2742c0a7b/fcda8/VSCode%20Go%20To%20References%20in%20Mocha.png 590w,\n/static/034c60797b097c8776c230f2742c0a7b/efc66/VSCode%20Go%20To%20References%20in%20Mocha.png 885w,\n/static/034c60797b097c8776c230f2742c0a7b/c83ae/VSCode%20Go%20To%20References%20in%20Mocha.png 1180w,\n/static/034c60797b097c8776c230f2742c0a7b/bb543/VSCode%20Go%20To%20References%20in%20Mocha.png 1418w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Above, we find that <code class=\"language-text\">Mocha::ClassMethods</code> is included into Class in <code class=\"language-text\">Mocha::API</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token builtin\">Class</span><span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token symbol\">:include</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">ClassMethods</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>We can continue doing the same approach, but at some point the ‚Äúsearch tree‚Äù got quite unwieldy so I switched to a more <strong>‚Äútop-down‚Äù approach</strong>, checking the README to see how the gem was <code class=\"language-text\">require</code>-d.</p>\n<h2>Know the Structure of a Gem</h2>\n<p>A quick detour on how a gem is structured - <code class=\"language-text\">lib/</code> generally contains the gem‚Äôs core logic. There you‚Äôll find a ruby file and a folder corresponding to the name of the gem. For example, in <code class=\"language-text\">mocha</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">lib/\n‚îî‚îÄ‚îÄ mocha.rb\n‚îî‚îÄ‚îÄ mocha/</code></pre></div>\n<p>The ruby file (e.g. <code class=\"language-text\">lib/mocha.rb</code>) generally contains most of the gem‚Äôs bootstrapping logic, as this is the file loaded when requiring the gem (i.e. <code class=\"language-text\">require &#39;mocha&#39;</code> would load <code class=\"language-text\">lib/mocha.rb</code>). So typically we‚Äôd start our ‚Äútop-down‚Äù search here.</p>\n<p><code class=\"language-text\">mocha</code> is slightly different - it supports multiple test libraries, and in the <a href=\"https://github.com/freerange/mocha/#minitest-1\">README</a> we are instructed to require a different file depending on our test library. For example, for <code class=\"language-text\">minitest</code> we‚Äôd do:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">require</span> <span class=\"token string\">'minitest/unit'</span>\n<span class=\"token keyword\">require</span> <span class=\"token string\">'mocha/minitest'</span></code></pre></div>\n<p>So in this case we‚Äôd start our search from <code class=\"language-text\">lib/mocha/minitest.rb</code>. There on it‚Äôs pretty straightforward Ruby, leading us back to <code class=\"language-text\">Mocha::API</code> (albeit with knowledge of how it gets required!).</p>\n<h2>Footnotes</h2>\n<ul>\n<li><a href=\"https://www.justinweiss.com/articles/how-to-dispel-ruby-magic-and-understand-your-gems\">How to Dispel Ruby Magic and Understand Your Gems (Justin Weiss)</a> - an inspiration for much of this</li>\n<li><a href=\"https://guides.rubygems.org/what-is-a-gem/\">Structure of a Gem (RubyGems)</a> - more details on how a gem is structured, along with a quick start so you can build your own gem!</li>\n<li>VSCode docs on <a href=\"https://code.visualstudio.com/docs/editor/codebasics#_search-across-files\">searching across files</a></li>\n</ul>","frontmatter":{"title":"Reading a Ruby gem with VSCode","date":"February 15, 2022","description":"Steps to try when investigating a gem's implementation in VSCode, using mocha's any_instance as an example."}}},"pageContext":{"slug":"/blog/reading-a-ruby-gem-with-vscode/","previous":{"fields":{"slug":"/blog/practical-metaprogramming-in-ruby-minitest-mock/"},"frontmatter":{"title":"Practical Metaprogramming in Ruby: minitest/mock"}},"next":{"fields":{"slug":"/blog/polymorphism-with-fries-please/"},"frontmatter":{"title":"Polymorphism, with fries please"}}}},"staticQueryHashes":["1003244115","2841359383"]}