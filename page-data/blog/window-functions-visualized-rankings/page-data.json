{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/window-functions-visualized-rankings/","result":{"data":{"site":{"siteMetadata":{"title":"wasabigeek"}},"markdownRemark":{"id":"698ee61b-867e-5319-b05b-a0e73a4bc3eb","excerpt":"Leading from an introduction to Window Function Calls, let’s dive deeper into the different Window Functions that are available. Today, we’ll look at ,  and…","html":"<p>Leading from an <a href=\"/blog/window-function-calls-an-introduction/\">introduction to Window Function Calls</a>, let’s dive deeper into the different Window Functions that are available. Today, we’ll look at <code class=\"language-text\">row_number</code>, <code class=\"language-text\">rank</code> and <code class=\"language-text\">dense_rank</code>. We’ll be using the same expenses table from the previous post, which had entries like:</p>\n<table>\n<thead>\n<tr>\n<th>description</th>\n<th>cost</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>bus ride</td>\n<td>3</td>\n</tr>\n<tr>\n<td>lunch</td>\n<td>15</td>\n</tr>\n<tr>\n<td>…</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>In the following examples, our <strong>window frame</strong> will be the whole expenses table, ordered by highest to lowest cost:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n  <span class=\"token punctuation\">[</span> window <span class=\"token keyword\">function</span> <span class=\"token punctuation\">]</span> <span class=\"token keyword\">OVER</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> cost <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  expenses<span class=\"token punctuation\">.</span>description<span class=\"token punctuation\">,</span>\n  expenses<span class=\"token punctuation\">.</span>cost\n<span class=\"token keyword\">FROM</span> expenses</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/116c3063fe1adc7cbe60400693705952/17d12/window_frame.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAB+UlEQVQoz3VS7ZKaQBDk/R8rdfmhd15ZeKeYKKiIigrCgnxDZ3qiqVRSN1XLFjuzPT3da0GiG4BGPlxl06NoBnwVg6TqrtdaU/X4t9Lq2hamqLE4ZHAvBfy4xLsXI8kr9F2LqpK9HwRIGjaN5j8POYJLitdlgLl3Qp5luN1umrculws818VqtcJsNsPPpYM0SeDv9wiCAMwbY9BKY9a9vk3w8vId75MJurZBXddwHAeJAEZRBIufxWIhYDZGoxHG4zHO5zOm0ymWzlIB0zTVi9udr7WfHx9wBTyKYlyvV9i2rc0PhwOsOI7BtdvusBdWvMA4Ho/KiuyMEcCmRRxu8MNh89+AXdehLEtst1sURaHNLc7OS77v43Q6KRPqxWTf93rBmAxtccPt5GEm7BbzuWrLyPNcpWCQrQJmIup6vUYYhg8nBx2BIpdVDRMdUWZXJKlROSgTa/SFCMv7/a7/CkgxqdFY9KMxDDLbbDYqepGGSNxvuB9tJCb/7xmxlusPIBlyfurgeZ4esmsgAtf3WADPSHYTFMGbmsA6mkD2DN6l9jryU8PnyBR6I6AE5Pg6ct0iDWYori5SYTg82Dyl+ZupMqQedPOrSORN0iiaw1rKc5ZmNO0ZTyMVkA6HjwIKzp0J7gSj8wy6yjOOTK05jU4gjQIZmcaw4S/pG47q6zyzvgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Original table to window frame\"\n        title=\"Original table to window frame\"\n        src=\"/static/116c3063fe1adc7cbe60400693705952/fcda8/window_frame.png\"\n        srcset=\"/static/116c3063fe1adc7cbe60400693705952/12f09/window_frame.png 148w,\n/static/116c3063fe1adc7cbe60400693705952/e4a3f/window_frame.png 295w,\n/static/116c3063fe1adc7cbe60400693705952/fcda8/window_frame.png 590w,\n/static/116c3063fe1adc7cbe60400693705952/efc66/window_frame.png 885w,\n/static/116c3063fe1adc7cbe60400693705952/c83ae/window_frame.png 1180w,\n/static/116c3063fe1adc7cbe60400693705952/17d12/window_frame.png 1666w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>row_number</h2>\n<p>Let’s start with <code class=\"language-text\">row_number</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> ROW_NUMBER<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> cost <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>All <code class=\"language-text\">row_number</code> does is add a running number for each row in the frame, starting from 1:</p>\n<table>\n<thead>\n<tr>\n<th>row_number</th>\n<th>description</th>\n<th>cost</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>groceries</td>\n<td>60</td>\n</tr>\n<tr>\n<td>2</td>\n<td>dinner</td>\n<td>35</td>\n</tr>\n<tr>\n<td>3</td>\n<td>taxi</td>\n<td>20</td>\n</tr>\n<tr>\n<td>4</td>\n<td>lunch</td>\n<td>15</td>\n</tr>\n<tr>\n<td>5</td>\n<td>lunch</td>\n<td>15</td>\n</tr>\n<tr>\n<td>6</td>\n<td>supper</td>\n<td>15</td>\n</tr>\n<tr>\n<td>7</td>\n<td>tea break</td>\n<td>5</td>\n</tr>\n<tr>\n<td>8</td>\n<td>bus ride</td>\n<td>4</td>\n</tr>\n<tr>\n<td>9</td>\n<td>bus ride</td>\n<td>3</td>\n</tr>\n<tr>\n<td>10</td>\n<td>bus ride</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<h2>dense_rank</h2>\n<p><code class=\"language-text\">dense_rank</code> is more interesting. Reviewing the previous example, we can see that there were a few entries that have the same cost. The Postgres documentation refers to these as <strong>peer groups</strong>, and <code class=\"language-text\">dense_rank</code> adds a running number counting by the groups instead of rows:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5ebdb9248832051f5d8c653f55af4d0e/ce92a/dense_rank.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.02702702702703%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAACUElEQVQ4y3WU23KbMBCG+/5Pk9teZJKbpq7bTNxJnY4PcQBDAAHGHGRxEn93hU3scaqZ9Y7R6tO/u5K+gEbf9+yQ5zmCIECSJEjTlHyMOB5MCIEwDLHb7RBFEXzfH7/zGv7P48s5kAMZNp1OMZ/PcXd/B8uy0HUtVqsVJpMJqqqCbdu4ubnBbDbDw8M3M8ebMecK6Loutq6HN8uGZTsUKEhVSnOxMVbIyljVyRjGG18p5JQ5GH2DrpFkB7S1hG4VhtEf7Xow2CjkH30EVnWNRHgI7Tk2yz9AkwN1Bq0SuOsZ8nCNPl2Cw7vCha6yYQv6cJHyaWSywqvjoQwXiLZ/ASWgZUBGaQcWVEHq670B9rolr0e9I7BuNZ6cAnHZYl8oRIGDXGzwNLlF6BC02UMfEoTbJeo8NKrPkz6V60Khm1bYxApS1XDtJaQsEYgYeSnHhWm6Q9NU6KVvlGm1o1LLEc7NUkoNQDtR+O2WKChlx/OQChuLxZJ2DUag77+j4A0OBNQd+opSr4sRyA3NsmwAeqTw+1uOdZBDpgFULggcwg8jE6x5QSFB1SEQKeu7s5T1NfDQdJC1xvtOUvt9qHiNpx/3WL/8JFqGdm/Bf32EFNTh0h06y03RDY4l/ACeimrAbQ/LecP7+pHsF54nX/E8veUzgu1mbpT3uW2AXENd+p+nbM6iHqQngY3IW8GzFwi2a7ibF0ozRZG4aGRMHRcm3hwd4/trhecTQkTo2ubyGhzr9L9b8qnCE5CvkEed5nMVsJm7Orw0H/7S+A3gB4OB/wB973xhjtMeBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Dense Rank Peer Groups\"\n        title=\"Dense Rank Peer Groups\"\n        src=\"/static/5ebdb9248832051f5d8c653f55af4d0e/fcda8/dense_rank.png\"\n        srcset=\"/static/5ebdb9248832051f5d8c653f55af4d0e/12f09/dense_rank.png 148w,\n/static/5ebdb9248832051f5d8c653f55af4d0e/e4a3f/dense_rank.png 295w,\n/static/5ebdb9248832051f5d8c653f55af4d0e/fcda8/dense_rank.png 590w,\n/static/5ebdb9248832051f5d8c653f55af4d0e/efc66/dense_rank.png 885w,\n/static/5ebdb9248832051f5d8c653f55af4d0e/c83ae/dense_rank.png 1180w,\n/static/5ebdb9248832051f5d8c653f55af4d0e/ce92a/dense_rank.png 1459w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>So changing the SQL to this:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> DENSE_RANK<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">OVER</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> cost <span class=\"token keyword\">DESC</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>Gives us this:</p>\n<table>\n<thead>\n<tr>\n<th>dense_rank</th>\n<th>description</th>\n<th>cost</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>groceries</td>\n<td>60</td>\n</tr>\n<tr>\n<td>2</td>\n<td>dinner</td>\n<td>35</td>\n</tr>\n<tr>\n<td>3</td>\n<td>taxi</td>\n<td>20</td>\n</tr>\n<tr>\n<td>4</td>\n<td>lunch</td>\n<td>15</td>\n</tr>\n<tr>\n<td>4</td>\n<td>lunch</td>\n<td>15</td>\n</tr>\n<tr>\n<td>4</td>\n<td>supper</td>\n<td>15</td>\n</tr>\n<tr>\n<td>5</td>\n<td>tea break</td>\n<td>5</td>\n</tr>\n<tr>\n<td>6</td>\n<td>bus ride</td>\n<td>4</td>\n</tr>\n<tr>\n<td>7</td>\n<td>bus ride</td>\n<td>3</td>\n</tr>\n<tr>\n<td>7</td>\n<td>bus ride</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Note</strong>: I’m actually not sure how Postgres orders the rows <em>within</em> a peer group - in my small example, it looks like an implicit <code class=\"language-text\">ORDER BY ID DESC</code> was added, but the Postgres <a href=\"https://www.postgresql.org/docs/current/queries-order.html\">docs</a> also say for general ordering, <em>if sorting is not chosen, the rows will be returned in an unspecified order</em> 🤷‍♂️.</p>\n<h2>rank</h2>\n<p><code class=\"language-text\">rank</code> has one big difference from <code class=\"language-text\">dense_rank</code> - it counts the “gaps” in the previous peer group:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/16828e5d43e47a6d721fa4d21f043acd/c1b63/rank.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 90.54054054054053%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsSAAALEgHS3X78AAAC+klEQVQ4y6VU227aQBDl/3+lD3lpHlqkViklUUiiQBrAIcGAsY1v+IJje9e305mFIFDUp640mp31zPHcO77vwzAMeJ6H7XYLlpmzbFmWos1mA9u2jzKT4zjqjblpmtB1HVVVocOPDNLv96FpGnq9Hi4vL5UynzAMMRgMFAifIAhwcXGB29tb9dbtfkdRFEovz3N0DGOFxWKBlxcN4/EzhsNHTCZjGKsVXNdVRvp8jjVHQTJ7wz+ezWbKbjqdKp3X11dIKdFhIU4SNC2QFQJl1aCmuyxrFKJUJMvqKEshUNUNhVcrAA6Tab1eQ9C3DudASgGUEVDHgNiiLQLFURDVCdCkaHOXdFIVNmqxp5PDOBx6x3E9yDzBevaA6+s+Ascg5Qx1QeBNhtXbGLPJEG3mog5flHHz7qDeGft70yjOhVOAHG4UBijjFSJnjibfe6e4jJH4BtLQRlslRJkybtuGqD3c23PAQkg41hKZ/4bV9BbaqA+REACHKyNsHR3+YoxmOUb9npyFyWCfAWWJzeIPSgp7RZU1lnOUIqdYSiKJNCVQY4Hix1fI5fMeqC6Vl//00LWXiL0lNq5P7fOCXZoevYjiBK7johzdQ2i/93lLLarffA94kkNVZRWybUAmFkxrQ33G5S+OgMkuwcayUT4/QL7dHzysKJ/izEMejpQcIUBBgGvqCEd5OJ5o8IPwCBjvMiTxO+TdDaT+dJK78xxmWabGtVMUOVxvS1Wmrh/20fv5DXFAY9ZSRd8teMsRzNkdxNUXFI9X1EkFeVifFYYP5497kQDJQ1NH7k2Rmg+IVgMsR99hTn6RloPQmiKyNSCnvKUmxNMIlU33baDy9wHIaeI8dnjkHKqyZczRv75RM9ntdqnJr5Wi59C2sdY0JQkVQt8XhYyl/vbJQwWoKkR/LCIyktzUPmlRv1UhKpqIlkdQhDQ5EZpKHvJGnh3APiblDJBjr+oW/3N4QRwBLcvEghbkhpcorSdT0frAzZM3c79gT+9ky7uTVxnzv0qZVWn3oEPSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Rank Peer Groups\"\n        title=\"Rank Peer Groups\"\n        src=\"/static/16828e5d43e47a6d721fa4d21f043acd/fcda8/rank.png\"\n        srcset=\"/static/16828e5d43e47a6d721fa4d21f043acd/12f09/rank.png 148w,\n/static/16828e5d43e47a6d721fa4d21f043acd/e4a3f/rank.png 295w,\n/static/16828e5d43e47a6d721fa4d21f043acd/fcda8/rank.png 590w,\n/static/16828e5d43e47a6d721fa4d21f043acd/efc66/rank.png 885w,\n/static/16828e5d43e47a6d721fa4d21f043acd/c83ae/rank.png 1180w,\n/static/16828e5d43e47a6d721fa4d21f043acd/c1b63/rank.png 1200w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Let’s compare the results of each function to show the difference:</p>\n<table>\n<thead>\n<tr>\n<th>dense_rank</th>\n<th>rank</th>\n<th>description</th>\n<th>cost</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>5</td>\n<td>7</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>6</td>\n<td>8</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>7</td>\n<td>9</td>\n<td>…</td>\n<td>…</td>\n</tr>\n<tr>\n<td>7</td>\n<td>9</td>\n<td>…</td>\n<td>…</td>\n</tr>\n</tbody>\n</table>\n<h2>percent_rank</h2>\n<p>TODO</p>\n<h2>side-by-side</h2>\n<p>Finally, let’s look at results side by side:</p>\n<table>\n<thead>\n<tr>\n<th>row_number</th>\n<th>dense_rank</th>\n<th>rank</th>\n<th>description</th>\n<th>cost</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1</td>\n<td>1</td>\n<td>groceries</td>\n<td>60</td>\n</tr>\n<tr>\n<td>2</td>\n<td>2</td>\n<td>2</td>\n<td>dinner</td>\n<td>35</td>\n</tr>\n<tr>\n<td>3</td>\n<td>3</td>\n<td>3</td>\n<td>taxi</td>\n<td>20</td>\n</tr>\n<tr>\n<td>4</td>\n<td>4</td>\n<td>4</td>\n<td>lunch</td>\n<td>15</td>\n</tr>\n<tr>\n<td>5</td>\n<td>4</td>\n<td>4</td>\n<td>lunch</td>\n<td>15</td>\n</tr>\n<tr>\n<td>6</td>\n<td>4</td>\n<td>4</td>\n<td>supper</td>\n<td>15</td>\n</tr>\n<tr>\n<td>7</td>\n<td>5</td>\n<td>7</td>\n<td>tea break</td>\n<td>5</td>\n</tr>\n<tr>\n<td>8</td>\n<td>6</td>\n<td>8</td>\n<td>bus ride</td>\n<td>4</td>\n</tr>\n<tr>\n<td>9</td>\n<td>7</td>\n<td>9</td>\n<td>bus ride</td>\n<td>3</td>\n</tr>\n<tr>\n<td>10</td>\n<td>7</td>\n<td>9</td>\n<td>bus ride</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<p>I hope that helped! Here’s an <a href=\"http://sqlfiddle.com/#!17/e9ac4/6\">sqlfiddle</a> you can play around with.</p>\n<p>For further reading, take a look at the Postgres docs on <a href=\"https://www.postgresql.org/docs/13/functions-window.html\">Window Functions</a>.</p>","frontmatter":{"title":"Window Functions, Visualized - Rankings","date":"January 04, 2021","description":"Picturing the differences between row_number, rank and dense_rank."}}},"pageContext":{"slug":"/blog/window-functions-visualized-rankings/","previous":{"fields":{"slug":"/blog/window-function-calls-an-introduction/"},"frontmatter":{"title":"Window Function Calls in Postgres - A Visual Introduction"}},"next":null}},"staticQueryHashes":["1003244115","2841359383"]}